// Конфигурация API
const API_BASE_URL = 'http://localhost:3000/api';

// Функция для получения всех табов
async function getTabs(searchQuery = '') {
    try {
        const url = searchQuery 
            ? `${API_BASE_URL}/tabs?search=${encodeURIComponent(searchQuery)}`
            : `${API_BASE_URL}/tabs`;
        
        const response = await fetch(url);
        if (!response.ok) throw new Error('Ошибка загрузки табов');
        return await response.json();
    } catch (error) {
        console.error('Ошибка:', error);
        showError('Не удалось загрузить табы');
        return [];
    }
}

// Функция для получения конкретного таба
async function getTab(id) {
    try {
        const response = await fetch(`${API_BASE_URL}/tabs/${id}`);
        if (!response.ok) throw new Error('Таб не найден');
        return await response.json();
    } catch (error) {
        console.error('Ошибка:', error);
        showError('Не удалось загрузить таб');
        return null;
    }
}

// Функция для добавления нового таба
async function addNewTab(title, artist, content) {
    try {
        const response = await fetch(`${API_BASE_URL}/tabs`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ title, artist, content })
        });
        
        if (!response.ok) throw new Error('Ошибка при добавлении таба');
        const result = await response.json();
        return result;
    } catch (error) {
        console.error('Ошибка:', error);
        showError('Не удалось добавить таб');
        return null;
    }
}

// Функция для оценки таба
async function rateTab(tabId, rating) {
    try {
        // Получаем IP пользователя (упрощенный способ)
        const user_ip = await getUserIP();
        
        const response = await fetch(`${API_BASE_URL}/tabs/${tabId}/rate`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ rating, user_ip })
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || 'Ошибка при оценке');
        }
        
        const result = await response.json();
        return result;
    } catch (error) {
        console.error('Ошибка:', error);
        showError(error.message || 'Не удалось оценить таб');
        return null;
    }
}

// Функция для получения IP пользователя
async function getUserIP() {
    try {
        const response = await fetch('https://api.ipify.org?format=json');
        const data = await response.json();
        return data.ip;
    } catch (error) {
        // Если не удалось получить IP, используем временный идентификатор
        return 'user_' + Math.random().toString(36).substr(2, 9);
    }
}

// Функция для отображения списка табов
async function renderTabsList(searchQuery = '') {
    const tabsList = document.getElementById('tabs-list');
    tabsList.innerHTML = '<div class="empty-state"><p>Загрузка...</p></div>';
    
    const tabs = await getTabs(searchQuery);
    
    if (tabs.length === 0) {
        tabsList.innerHTML = '<div class="empty-state"><p>Табы не найдены</p></div>';
        return;
    }
    
    tabsList.innerHTML = tabs.map(tab => `
        <div class="tab-item" data-id="${tab.id}">
            <div class="tab-title">${escapeHtml(tab.title)}</div>
            <div class="tab-artist">${escapeHtml(tab.artist)}</div>
            <div class="rating">
                <div class="stars">${renderStars(tab.rating)}</div>
                <div class="rating-count">${parseFloat(tab.rating).toFixed(1)} (${tab.votes})</div>
            </div>
        </div>
    `).join('');
    
    // Добавляем обработчики событий для элементов списка
    document.querySelectorAll('.tab-item').forEach(item => {
        item.addEventListener('click', function() {
            const tabId = parseInt(this.getAttribute('data-id'));
            displayTab(tabId);
            
            // Убираем активный класс у всех элементов и добавляем текущему
            document.querySelectorAll('.tab-item').forEach(el => el.classList.remove('active'));
            this.classList.add('active');
        });
    });
}

// Функция для отображения выбранного таба
async function displayTab(tabId) {
    const tabContent = document.getElementById('tab-content');
    tabContent.innerHTML = '<div class="empty-state"><p>Загрузка...</p></div>';
    
    const tab = await getTab(tabId);
    
    if (!tab) return;
    
    tabContent.innerHTML = `
        <div class="tab-header">
            <div class="tab-details">
                <h2>${escapeHtml(tab.title)}</h2>
                <div class="artist">${escapeHtml(tab.artist)}</div>
            </div>
        </div>
        <div class="tab-text">${escapeHtml(tab.content)}</div>
        <div class="rate-tab">
            <select id="rating-select">
                <option value="5">5 ★</option>
                <option value="4">4 ★</option>
                <option value="3">3 ★</option>
                <option value="2">2 ★</option>
                <option value="1">1 ★</option>
            </select>
            <button id="rate-button" data-id="${tab.id}">Оценить</button>
        </div>
    `;
    
    // Добавляем обработчик для кнопки оценки
    document.getElementById('rate-button').addEventListener('click', async function() {
        const ratingValue = parseInt(document.getElementById('rating-select').value);
        const result = await rateTab(tabId, ratingValue);
        
        if (result) {
            showMessage('Спасибо за вашу оценку!');
            // Обновляем отображение таба
            displayTab(tabId);
            // Обновляем список табов
            renderTabsList(document.getElementById('search-input').value);
        }
    });
}

// Функция для добавления нового таба
async function handleAddNewTab(title, artist, content) {
    const result = await addNewTab(title, artist, content);
    
    if (result) {
        showMessage('Таб успешно добавлен!');
        
        // Переключаемся на вкладку просмотра
        switchTab('browse');
        
        // Обновляем список и показываем новый таб
        await renderTabsList();
        await displayTab(result.id);
        
        // Выделяем новый таб в списке
        setTimeout(() => {
            const newTabElement = document.querySelector(`.tab-item[data-id="${result.id}"]`);
            if (newTabElement) {
                document.querySelectorAll('.tab-item').forEach(el => el.classList.remove('active'));
                newTabElement.classList.add('active');
            }
        }, 100);
        
        return true;
    }
    return false;
}

// Вспомогательные функции
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function renderStars(rating) {
    const numRating = parseFloat(rating);
    const fullStars = Math.floor(numRating);
    const halfStar = numRating % 1 >= 0.5;
    const emptyStars = 5 - fullStars - (halfStar ? 1 : 0);
    
    return '★'.repeat(fullStars) + (halfStar ? '½' : '') + '☆'.repeat(emptyStars);
}

function showMessage(message) {
    alert(message); // Можно заменить на красивый toast
}

function showError(message) {
    alert('Ошибка: ' + message); // Можно заменить на красивый toast
}

function switchTab(tabName) {
    document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));
    
    document.querySelector(`.nav-tab[data-tab="${tabName}"]`).classList.add('active');
    document.getElementById(`${tabName}-panel`).classList.add('active');
}

// Инициализация при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    // Отображаем список табов
    renderTabsList();
    
    // Обработчик для поиска
    document.getElementById('search-button').addEventListener('click', function() {
        const query = document.getElementById('search-input').value;
        renderTabsList(query);
    });
    
    // Обработчик для поиска при нажатии Enter
    document.getElementById('search-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            const query = this.value;
            renderTabsList(query);
        }
    });
    
    // Обработчик для формы добавления таба
    document.getElementById('add-tab-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const title = document.getElementById('tab-title').value;
        const artist = document.getElementById('tab-artist').value;
        const content = document.getElementById('tab-content-text').value;
        
        if (title && artist && content) {
            const success = await handleAddNewTab(title, artist, content);
            if (success) {
                this.reset();
            }
        }
    });
    
    // Обработчики для переключения вкладок
    document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.addEventListener('click', function() {
            const tabName = this.getAttribute('data-tab');
            switchTab(tabName);
        });
    });
});
